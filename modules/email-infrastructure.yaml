name: "Email Infrastructure Detection"
enabled: true
rules:
  - name: "Free email provider usage"
    criteria:
      type: "EmailInfrastructure"
      infrastructure_type: "free_email"
      domains:
        - "gmail.com"
        - "yahoo.com"
        - "hotmail.com"
        - "outlook.com"
        - "aol.com"
        - "icloud.com"
        - "protonmail.com"
        - "mail.com"
      check_sender: true
      check_reply_to: false
      exclude_legitimate: true
    score: 15
    description: "Emails from free email providers"

  - name: "Educational domain compromise"
    criteria:
      type: "EmailInfrastructure"
      infrastructure_type: "educational"
      tld_patterns:
        - ".*@.*\\.edu\\.[a-z]{2}$"
        - ".*@.*\\.edu$"
      check_sender: true
      check_reply_to: false
      exclude_legitimate: false
    score: 35
    description: "Potentially compromised educational domains"

  - name: "Microsoft tenant compromise"
    criteria:
      type: "EmailInfrastructure"
      infrastructure_type: "compromised"
      tld_patterns:
        - ".*@.*\\.onmicrosoft\\.com$"
      check_sender: true
      check_reply_to: false
      require_auth_failure: true
      exclude_legitimate: false
    score: 45
    description: "Compromised Microsoft tenant accounts with authentication failures"

  - name: "Business email compromise indicators"
    criteria:
      type: "And"
      criteria:
        - type: "EmailInfrastructure"
          infrastructure_type: "business"
          tld_patterns:
            - ".*@.*\\.(com|org|net)$"
          check_sender: true
          require_auth_failure: true
        - type: "Not"
          criteria:
            type: "SenderPattern"
            pattern: ".*@.*(gov|government|public).*"
        - type: "Or"
          criteria:
            - type: "SubjectPattern"
              pattern: "(?i).*(urgent.*payment|invoice.*attached|wire.*transfer|account.*suspended|verify.*account).*"
            - type: "BodyPattern"
              pattern: "(?i).*(urgent.*action|immediate.*payment|wire.*transfer|bank.*details|account.*verification).*"
    score: 60
    description: "Business email compromise with authentication failure and financial urgency"

  - name: "Suspicious cloud service domains"
    criteria:
      type: "EmailInfrastructure"
      infrastructure_type: "cloud_service"
      domains:
        - "googleusercontent.com"
        - "amazonaws.com"
        - "azurewebsites.net"
        - "herokuapp.com"
        - "netlify.app"
        - "vercel.app"
      check_sender: true
      check_reply_to: true
      exclude_legitimate: true
    score: 25
    description: "Emails from cloud service domains often used for temporary campaigns"
