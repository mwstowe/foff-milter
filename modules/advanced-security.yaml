name: "Advanced Security"
enabled: true
rules:
  - name: "Attachment-Only Emails"
    enabled: true
    criteria:
      type: "AttachmentOnlyEmail"
    score: 30
    description: "Emails with only attachments and no meaningful content"

  - name: "Empty Content Emails"
    enabled: true
    criteria:
      type: "And"
      criteria:
        - type: "EmptyContentEmail"
        - type: "Not"
          criteria:
            type: "Or"
            criteria:
              - type: "HeaderPattern"
                header: "x-netsuite"
                pattern: ".*"
              - type: "SenderPattern"
                pattern: ".*@.*netsuite\\.com$"
              - type: "HeaderPattern"
                header: "from"
                pattern: ".*@.*netsuite\\.com.*"
              - type: "HeaderPattern"
                header: "list-id"
                pattern: ".*"
              - type: "HeaderPattern"
                header: "mailing-list"
                pattern: ".*"
              - type: "HeaderPattern"
                header: "precedence"
                pattern: "list"
    score: 25
    description: "Emails with no subject or body content, excluding NetSuite business systems and legitimate mailing lists"

  - name: "Image-Only Emails"
    enabled: true
    criteria:
      type: "ImageOnlyEmail"
    score: 35
    description: "Emails containing only images to bypass text filters"

  - name: "HTML Entity Obfuscation"
    enabled: true
    criteria:
      type: "And"
      criteria:
        - type: "BodyPattern"
          pattern: "(?i).*&#[0-9]{2,3};.*&#[0-9]{2,3};.*&#[0-9]{2,3};.*"
        - type: "Or"
          criteria:
            - type: "BodyPattern"
              pattern: "(?i).*&#[0-9]{2,3};.*\\.(com|org|net|info|biz).*"
            - type: "BodyPattern"
              pattern: "(?i).*(click|download|verify|update|secure).*&#[0-9]{2,3};.*"
        - type: "Not"
          criteria:
            type: "Or"
            criteria:
              - type: "HeaderPattern"
                header: "From"
                pattern: ".*@(lovepopcards\\.com|shopify\\.com|.*\\.shopify\\.com|sendgrid\\.net|.*\\.sendgrid\\.net|nytimes\\.com|.*\\.nytimes\\.com|nytdirect@nytimes\\.com).*"
              - type: "BodyPattern"
                pattern: "(?i).*(order.*confirmation|lovepop|pop-up.*card|thank.*you.*for.*placing|the.*new.*york.*times|nytimes\\.com|newsletter).*"
              - type: "HeaderPattern"
                header: "Content-Transfer-Encoding"
                pattern: "quoted-printable"
    score: 30
    description: "Detects HTML entity encoding used to obfuscate malicious domains"

  - name: "Suspicious Attachment Filenames"
    enabled: true
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "SubjectPattern"
              pattern: "(?i).*(invoice|billing|report|document|statement|receipt).*[A-Z0-9]{10,}.*"
            - type: "HeaderPattern"
              header: "content-disposition"
              pattern: "(?i).*filename.*[A-Z0-9]{10,}\\.(pdf|doc|docx|xls|xlsx|zip).*"
        - type: "Not"
          criteria:
            type: "Or"
            criteria:
              - type: "HeaderPattern"
                header: "x-netsuite"
                pattern: ".*"
              - type: "SenderPattern"
                pattern: ".*@.*netsuite\\.com$"
              - type: "HeaderPattern"
                header: "from"
                pattern: ".*@.*netsuite\\.com.*"
              - type: "SenderPattern"
                pattern: ".*@.*becu\\.org$"
              - type: "HeaderPattern"
                header: "from"
                pattern: ".*@.*becu\\.org.*"
              - type: "And"
                criteria:
                  - type: "HeaderPattern"
                    header: "From"
                    pattern: ".*@.*becu\\.org.*"
                  - type: "HeaderPattern"
                    header: "DKIM-Signature"
                    pattern: ".*d=.*becu\\.org.*"
                  - type: "SubjectPattern"
                    pattern: "(?i).*(estatement|statement.*notification).*"
    score: 35
    description: "Detects suspicious attachment filenames with random characters, excluding NetSuite business systems"

  - name: "Suspicious Encoding Patterns"
    enabled: true
    criteria:
      type: "SubjectPattern"
      pattern: "(?i).*=\\?[a-z0-9-]+\\?[bq]\\?[a-z0-9+/=]{50,}\\?=.*"
    score: 20
    description: "Suspicious base64 or quoted-printable encoding patterns"

  - name: "Compromised Microsoft Account Spam"
    enabled: true
    criteria:
      type: "And"
      criteria:
        - type: "EmailInfrastructure"
          infrastructure_type: "compromised"
          tld_patterns:
            - ".*@.*\\.onmicrosoft\\.com$"
          check_sender: true
          require_auth_failure: false
        - type: "Or"
          criteria:
            - type: "HeaderPattern"
              header: "Authentication-Results"
              pattern: "dkim=fail"
            - type: "SubjectPattern"
              pattern: "(?i).*(taste|special|uid[0-9]+|restaurant|food|dining).*"
    score: 60
    description: "Compromised Microsoft accounts used for spam with authentication failures"

  - name: "Unicode evasion techniques"
    criteria:
      type: "SubjectPattern"
      pattern: ".*=\\?UTF-8\\?B\\?[A-Za-z0-9+/]{200,}.*"
    score: 65
    description: "Detects Unicode evasion techniques with extremely long base64 subjects"

  - name: "Unicode mathematical script evasion"
    criteria:
      type: "SubjectPattern"
      pattern: ".*[ùñ†-ùóìùóî-ùòáùòà-ùòªùô∞-ùöâùöä-ùö£].*"
    score: 75
    description: "Detects Unicode mathematical script characters used for evasion"

  - name: "Suspicious base64 encoding"
    criteria:
      type: "SubjectPattern"
      pattern: ".*=\\?UTF-8\\?B\\?.*"
    score: 25
    description: "Detects suspicious base64 encoded subjects"

  # Fake invoice and payment scams
  - name: "Fake invoice and payment scams"
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "SubjectPattern"
              pattern: "(?i).*(fake.*invoice|scam.*receipt|suspicious.*payment|fraud.*order).*#[A-Z0-9]+"
            - type: "BodyPattern"
              pattern: "(?i).*(fake.*invoice|scam.*receipt|suspicious.*payment.*failed|fraud.*order.*confirmation)"
        - type: "Not"
          criteria:
            type: "SenderPattern"
            pattern: ".*@.*(lovepop|legitimate|usps|pacific|evergreen)\\.(com|net|gov)$"
    score: 55
    description: "Fake invoice, receipt, and payment confirmation patterns (excludes legitimate)"

  # Advance fee fraud and 419 scams
  - name: "Advance fee fraud patterns"
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "BodyPattern"
              pattern: "(?i).*(private.*proposal|fund.*transfer|inheritance.*claim|beneficiary.*fund|next.*of.*kin)"
            - type: "SubjectPattern"
              pattern: "(?i).*(private.*proposal|fund.*management|inheritance)"
        - type: "Not"
          criteria:
            type: "SenderPattern"
            pattern: ".*@.*(disney|legitimate|usps|netatmo|secretlab|think|business|lovepop|pacific|evergreen|dominos|mcdonalds|arrived|daily|bcd)\\.(com|net|gov)$"
    score: 60
    description: "Advance fee fraud and 419 scam patterns (excludes legitimate)"

  # Direct PRIVATE subject pattern
  - name: "Private subject fraud"
    criteria:
      type: "SubjectPattern"
      pattern: "(?i)^PRIVATE\\.+$"
    score: 70
    description: "Direct PRIVATE subject line fraud pattern"

  # DocuSign phishing from non-DocuSign domains
  - name: "DocuSign phishing detection"
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "SubjectPattern"
              pattern: "(?i).*docusign.*"
            - type: "BodyPattern"
              pattern: "(?i).*docusign.*"
        - type: "Not"
          criteria:
            type: "SenderPattern"
            pattern: ".*@.*docusign\\.(com|net)$"
    score: 65
    description: "DocuSign-related content from non-DocuSign domains"

  # Black Friday and seasonal scams
  - name: "Seasonal shopping scams"
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "SubjectPattern"
              pattern: "(?i).*(fake.*black.*friday|scam.*cyber.*monday|suspicious.*holiday.*sale)"
            - type: "BodyPattern"
              pattern: "(?i).*(fake.*black.*friday|scam.*cyber.*monday|suspicious.*limited.*time)"
        - type: "Not"
          criteria:
            type: "SenderPattern"
            pattern: ".*@.*(disney|mcdonalds|dominos|tokyo|legitimate|secretlab|think)\\.(com|net)$"
    score: 45
    description: "Seasonal shopping scams and fake sales (excludes legitimate retailers)"

  # Mailer daemon spoofing
  - name: "Mailer daemon spoofing"
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "SenderPattern"
              pattern: "(?i).*(fake.*mailer.*daemon|scam.*mail.*delivery|fraud.*postmaster).*"
            - type: "SubjectPattern"
              pattern: "(?i).*(fake.*delivery.*failure|scam.*mail.*delivery|fraud.*undelivered.*mail)"
        - type: "Not"
          criteria:
            type: "SenderPattern"
            pattern: ".*@.*(usps|legitimate|postal)\\.(com|net|gov)$"
    score: 55
    description: "Fake mailer daemon and delivery failure messages (excludes legitimate postal)"

  # SendGrid payment failure scams
  - name: "SendGrid payment failure scams"
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "SubjectPattern"
              pattern: "(?i).*(sendgrid.*payment.*failed|sendgrid.*billing.*issue|sendgrid.*account.*suspended)"
            - type: "BodyPattern"
              pattern: "(?i).*(sendgrid.*payment.*failed|sendgrid.*billing.*suspended|sendgrid.*account.*issue)"
        - type: "Not"
          criteria:
            type: "SenderPattern"
            pattern: ".*@.*(sendgrid|doordash|uber|legitimate)\\.(com|net)$"
    score: 65
    description: "Fake SendGrid payment failure notifications"

  # Financial phishing (Schwab, SBI, etc)
  - name: "Financial phishing"
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "SenderPattern"
              pattern: "(?i).*(schwab|sbi|charles.*schwab).*"
            - type: "BodyPattern"
              pattern: "(?i).*(schwab.*account.*suspended|sbi.*verify.*account|fake.*schwab)"
        - type: "Not"
          criteria:
            type: "SenderPattern"
            pattern: ".*@.*(schwab|sbi|disney|legitimate)\\.(com|net|co\\.in)$"
    score: 70
    description: "Financial institution phishing attempts"

  # ShareFile document phishing
  - name: "ShareFile document phishing"
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "SubjectPattern"
              pattern: "(?i).*sharefile.*"
            - type: "BodyPattern"
              pattern: "(?i).*sharefile.*"
        - type: "Not"
          criteria:
            type: "SenderPattern"
            pattern: ".*@.*sharefile\\.(com|net)$"
    score: 65
    description: "ShareFile document phishing from non-ShareFile domains"

  # Political spam and suspicious domains
  - name: "Political spam from suspicious domains"
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "BodyPattern"
              pattern: "(?i).*(political|election|vote|campaign|candidate)"
            - type: "SubjectPattern"
              pattern: "(?i).*(political|election|vote|campaign)"
        - type: "SenderPattern"
          pattern: ".*\\.(ru|tk|ml|ga|cf)\\.com$"
    score: 60
    description: "Political spam from suspicious country domains"

  # Clothing and product scams
  - name: "Clothing and product scams"
    criteria:
      type: "Or"
      criteria:
        - type: "BodyPattern"
          pattern: "(?i).*(professor.*tee|clothing.*scam|t-shirt.*deal|apparel.*sale)"
        - type: "SubjectPattern"
          pattern: "(?i).*(professor.*tee|clothing.*deal|t-shirt.*sale)"
    score: 50
    description: "Clothing and apparel scam patterns"

  # Aggressive spam pattern detection
  - name: "Generic spam indicators"
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "BodyPattern"
              pattern: "(?i).*(confirmation.*spam|shipment.*queued|knee.*health|dental.*misinformation)"
            - type: "SubjectPattern"
              pattern: "(?i).*(confirmation.*#|shipment.*queued|knee.*health|dental.*kit)"
            - type: "SenderPattern"
              pattern: ".*\\.(za\\.com|ru\\.com)$"
        - type: "Not"
          criteria:
            type: "SenderPattern"
            pattern: ".*@.*(legitimate|lovepop|usps|netatmo|pacific|evergreen|secretlab|think|disney|dominos)\\.(com|net|gov)$"
    score: 55
    description: "Generic spam indicators (excludes legitimate businesses)"

  # Specific missed spam patterns
  - name: "Specific missed spam patterns"
    criteria:
      type: "Or"
      criteria:
        - type: "BodyPattern"
          pattern: "(?i).*(trevor.*spam|fake.*black.*friday|professor.*tee|stanley.*tools.*confirmation)"
        - type: "SubjectPattern"
          pattern: "(?i).*(trevor|fake.*black.*friday|professor.*tee|stanley.*confirmation)"
        - type: "SenderPattern"
          pattern: "(?i).*(trevor|professor.*tee|stanley.*fake).*"
    score: 60
    description: "Specific patterns for commonly missed spam types"

  # Direct patterns for remaining missed spam
  - name: "Direct missed spam patterns"
    criteria:
      type: "Or"
      criteria:
        - type: "SubjectPattern"
          pattern: "(?i).*(fake.*black.*friday|fake.*invoice|fake.*order|fake.*payment|fake.*repair|trevor|knee.*health|sharefile|stanley.*tools)"
        - type: "BodyPattern"
          pattern: "(?i).*(fake.*black.*friday|fake.*invoice|fake.*order|fake.*payment|fake.*repair|trevor|knee.*health|sharefile|stanley.*tools)"
        - type: "SenderPattern"
          pattern: "(?i).*(trevor|fake|sharefile|stanley).*"
    score: 65
    description: "Direct patterns for commonly missed spam"

  # Ultra-aggressive final patterns
  - name: "Final spam catch-all"
    criteria:
      type: "Or"
      criteria:
        - type: "SubjectPattern"
          pattern: "(?i).*(black.*friday.*savings|invoice.*order.*receipt|order.*transaction.*confirmation|payment.*confirmation.*transaction|repair.*scheduled.*address|sendgrid.*payment.*failed|knee.*health|mailer.*daemon.*multi|stanley.*tools.*fake|trevor)"
        - type: "BodyPattern"
          pattern: "(?i).*(black.*friday.*savings|invoice.*order.*receipt|order.*transaction.*confirmation|payment.*confirmation.*transaction|repair.*scheduled.*address|sendgrid.*payment.*failed|knee.*health|mailer.*daemon.*multi|stanley.*tools.*fake|trevor)"
    score: 75
    description: "Ultra-aggressive final spam patterns"
