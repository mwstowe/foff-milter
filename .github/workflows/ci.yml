name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      run: cargo fmt --all -- --check
    
    - name: Run clippy
      run: cargo clippy --all-targets --all-features -- -D warnings
    
    - name: Run unit tests
      run: cargo test --verbose
    
    - name: Build release
      run: cargo build --release --verbose

  email-tests:
    name: Email Detection Tests
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Build release binary
      run: cargo build --release
    
    - name: Run email test suite
      run: |
        echo "ðŸ§ª Running comprehensive email detection tests..."
        ./tests/run_tests.sh
        
    - name: Test configuration validation
      run: |
        echo "ðŸ”§ Testing configuration validation..."
        ./target/release/foff-milter --test-config -c foff-milter.toml
        
    - name: Generate test report
      run: |
        echo "ðŸ“Š Email Detection Test Results" >> $GITHUB_STEP_SUMMARY
        echo "================================" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Count test files
        POSITIVE_COUNT=$(find tests/positive -name "*.eml" | wc -l)
        NEGATIVE_COUNT=$(find tests/negative -name "*.eml" | wc -l)
        TOTAL_COUNT=$((POSITIVE_COUNT + NEGATIVE_COUNT))
        
        echo "ðŸ“ˆ **Test Coverage:**" >> $GITHUB_STEP_SUMMARY
        echo "- Spam Detection Tests: $POSITIVE_COUNT emails" >> $GITHUB_STEP_SUMMARY
        echo "- False Positive Tests: $NEGATIVE_COUNT emails" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Test Cases: $TOTAL_COUNT emails**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Run tests and capture results
        if ./tests/run_tests.sh > test_results.log 2>&1; then
          SUCCESS_RATE=$(tail -5 test_results.log | grep "Success Rate" | cut -d: -f2 | tr -d ' ')
          echo "âœ… **All tests passed!** Success Rate: $SUCCESS_RATE" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Some tests failed.** Check logs for details." >> $GITHUB_STEP_SUMMARY
        fi

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Install cargo-audit
      run: cargo install cargo-audit
    
    - name: Run security audit
      run: cargo audit
