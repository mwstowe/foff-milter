# My rules!
socket_path: "/var/run/foff-milter.sock"
default_action:
  type: "Accept"

# Statistics configuration
statistics:
  enabled: true                              # Enable/disable statistics collection
  database_path: "/var/db/foff/stats.db"     # SQLite database location
  flush_interval_seconds: 300                 # How often to flush stats to disk (optional, default: 60)


rules:
  # Block Chinese services with Japanese content
  - name: "Block Chinese services with Japanese content"
    criteria:
      type: "And"
      criteria:
        - type: "Or"
          criteria:
            - type: "SenderPattern"
              pattern: ".*@service\\.[^.]+\\.cn$"  # Matches service.vpoy.cn
            - type: "SenderPattern"  
              pattern: ".*@service\\..*\\.cn$"    # Matches service.something.cn
        - type: "SubjectContainsLanguage"
          language: "japanese"
    action:
      type: "Reject"
      message: "Chinese service with Japanese content blocked"


  # Calvalcade of Japenese spam
  - name: "Block spam with Japanese content"
    criteria:
      type: "And"
      criteria:
        - type: "SenderPattern"
          pattern: "service\\..*\\.com"
        - type: "SubjectContainsLanguage"
          language: "japanese"
    action:
      type: "Reject"
      message: "Spam rejected"

  # Conservative dipshit spam
  - name: "Conservative dipshit spam"
    criteria:
      type: "And"
      criteria:
        - type: "MailerPattern"
          pattern: ".*\\.sparkpostmail\\.com"
        - type: "RecipientPattern"
          pattern: "queued@baddomain\\.com"
    action:
      type: "Reject"
      message:  "Fuck off, Nazis"

  - name: "Tag Google API unsubscribe links"
    criteria:
      type: "UnsubscribeLinkPattern"
      pattern: ".*\\.googleapis\\.com.*"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  # Tag Russian spam
  - name: "Nothing good ever came out of ru.com"
    criteria:
      type: "SenderPattern"
      pattern: ".*\\.ru\\.com"
    action:
      type: "Reject"
      message: "Spam rejected"

  # Tag these chuckleheads
  - name: "Fake Microsoft"
    criteria:
      type: "Or"
      criteria:
      - type: "HeaderPattern"
        header: "reply-to"
        pattern: ".*onmicrosoft\\.com"
      - type: "HeaderPattern"
        header: "from"
        pattern: ".*onmicrosoft\\.com"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  # Tag these chuckleheads
  - name: "aizen.ink"
    criteria:
      type: "SenderPattern"
      pattern: ".*\\.aizen\\.ink"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  # Tag these chuckleheads
  - name: "*.za.com"
    criteria:
      type: "SenderPattern"
      pattern: ".*\\.za\\.com"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  # Tag these chuckleheads
  - name: "*.sa.com"
    criteria:
      type: "SenderPattern"
      pattern: ".*\\.sa\\.com"
    action:
      type: "Reject"
      message: "Fuck right off"

  # Tag emails with invalid unsubscribe links (DNS check only - fast)
  - name: "Invalid unsubscribe links (DNS only)"
    criteria:
      type: "UnsubscribeLinkValidation"
      timeout_seconds: 10
      check_dns: true
      check_http: false
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Microsoft Reply Spam"
    criteria:
      type: "And"
      criteria:
      - type: "HeaderPattern"
        header: "Auto-Submitted"
        pattern: "auto-replied"
      - type: "HeaderPattern"
        header: "X-MS-PublicTrafficType"
        pattern: ".*"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Click domains"
    criteria:
      type: "Or"
      criteria:
      - type: "SenderPattern"
        pattern: ".*@.*\\.click$"
      - type: "HeaderPattern"
        header: "received"
        pattern: ".*\\.click"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  # Detect sender spoofing - when display name claims to be from a trusted domain
  # but the actual sender is from a different domain
  - name: "Detect sender spoofing"
    criteria:
      type: "PhishingSenderSpoofing"
      trusted_domains:
        - "baddomain.com"
        - "paypal.com"
        - "amazon.com"
        - "microsoft.com"
        - "google.com"
        - "apple.com"
        - "netflix.com"
    action:
      type: "TagAsSpam"
      header_name: "X-Phishing-Spoofing"
      header_value: "Sender spoofing detected"

  # Comprehensive phishing detection rule combining multiple indicators
  - name: "Comprehensive phishing detection"
    criteria:
      type: "Or"
      criteria:
        # Urgent/threatening language with suspicious sender
        - type: "And"
          criteria:
            - type: "SubjectPattern"
              pattern: "(?i)(expire|suspend|verify|update|confirm|urgent|immediate|security|alert|warning)"
            - type: "Or"
              criteria:
                - type: "PhishingSenderSpoofing"
                  trusted_domains: ["baddomain.com", "paypal.com", "amazon.com", "microsoft.com"]
                - type: "PhishingDomainMismatch"
                  allow_subdomains: true
        # Suspicious links with urgent language
        - type: "And"
          criteria:
            - type: "PhishingSuspiciousLinks"
              check_url_shorteners: true
              check_suspicious_tlds: true
              check_ip_addresses: true
            - type: "SubjectPattern"
              pattern: "(?i)(click|release|inbox|email|message|account)"
    action:
      type: "TagAsSpam"
      header_name: "X-Phishing"
      header_value:  Suspicious

  - name: "Detect SendGrid phishing redirects"
    criteria:
      type: "PhishingLinkRedirection"
      max_redirects: 5
      timeout_seconds: 10
      check_final_destination: true
      suspicious_redirect_patterns:
        - ".*\\.sslip\\.io.*"  # Suspicious wildcard DNS service
        - ".*wordpress-.*"    # Compromised WordPress sites
        - ".*\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}.*"  # IP addresses
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "SendGrid with free email reply-to"
    criteria:
      type: "And"
      criteria:
        - type: "MailerPattern"
          pattern: ".*sendgrid\\.net.*"
        - type: "PhishingFreeEmailReplyTo"
          free_email_domains: ["outlook.com", "gmail.com", "yahoo.com", "hotmail.com"]
          allow_same_domain: false
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

# Detect and tag emails that are primarily images with minimal text
  - name: "Tag image-only emails"
    criteria:
      type: "ImageOnlyEmail"
      max_text_length: 30  # Allow up to 30 characters of text
      ignore_whitespace: true  # Don't count whitespace as meaningful text
      check_attachments: false  
    action:
      type: "TagAsSpam"
      header_name: "X-Image-Only-Email"
      header_value: "YES"

  - name: "Detect free email reply-to phishing"
    criteria:
      type: "PhishingFreeEmailReplyTo"
      # Optional: specify custom free email domains (defaults to common ones)
      # free_email_domains:
      #   - "gmail.com"
      #   - "yahoo.com"
      #   - "hotmail.com"
      #   - "outlook.com"
      # Optional: allow same domain (default: false)
      # allow_same_domain: false
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Validate reply-to DNS resolution"
    criteria:
      type: "ReplyToValidation"
      # Optional: DNS lookup timeout in seconds (default: 5)
      timeout_seconds: 5
      # Optional: check for MX records in addition to A/AAAA (default: true)
      check_mx_record: true
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Comprehensive young domain check"
    criteria:
      type: "DomainAge"
      max_age_days: 365
      check_sender: true
      check_reply_to: true
      check_from_header: true
      timeout_seconds: 8
      use_mock_data: false
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  # Broader brand protection
  - name: "Brand Impersonation - Free Email"
    criteria:
      type: "And"
      criteria:
      - type: "HeaderPattern"
        header: "from"
        pattern: "(?i)@(outlook|gmail|yahoo|hotmail)\\.com$"
      - type: "Or"
        criteria:
        - type: "SubjectPattern"
          pattern: "(?i).*(paypal|amazon|microsoft|apple|google|bank|security|account|verify).*"
        - type: "HeaderPattern"
          header: "from"
          pattern: "(?i).*(paypal|amazon|microsoft|apple|google|bank).*"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Block bulk spam with undisclosed recipients from free email"
    criteria:
      type: "And"
      criteria:
        - type: "HeaderPattern"
          header: "to"
          pattern: "(?i)undisclosed.{0,15}recipients"
        - type: "SenderPattern"
          pattern: ".*@(outlook|gmail|yahoo|hotmail|aol|msn|live|protonmail|icloud|yandex|mail|gmx)\\.(com|net|org|ru)$"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Block emails with invalid unsubscribe headers"
    criteria:
      type: "InvalidUnsubscribeHeaders"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Block unsubscribe links with IP addresses"
    criteria:
      type: "UnsubscribeLinkIPAddress"
      check_ipv4: true
      check_ipv6: true
      allow_private_ips: false  # Block private IPs (default)
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Tag empty emails from free email services"
    criteria:
      type: "And"
      criteria:
        - type: "SenderPattern"
          pattern: ".*@(gmail|outlook|yahoo|hotmail|aol)\\.(com|net|org)$"
        - type: "EmptyContentEmail"
          max_text_length: 10
          ignore_whitespace: true
          ignore_signatures: true
          require_empty_subject: false
          min_subject_length: 5
          ignore_html_tags: true
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Tag RAR attachments"
    criteria:
      type: "AttachmentOnlyEmail"
      max_text_length: 50000
      suspicious_types: ["rar"]
      min_attachment_size: 256
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Block phishing with DKIM failure and domain mismatch"
    criteria:
      type: "And"
      criteria:
        # DKIM authentication failed
        - type: "HeaderPattern"
          header: "authentication-results"
          pattern: "dkim=fail"
      
        # Suspicious TLD
        - type: "SenderPattern"
          pattern: ".*@.*\\.(top|tk|ml|ga|cf|click|download|loan|racing|review|science|work|party|date|stream|trade|bid|win|cricket|accountant|faith|men|gq)$"
      
        # Free email reply-to
        - type: "HeaderPattern"
          header: "reply-to"
          pattern: ".*@(gmail|outlook|yahoo|hotmail|zoho|aol|protonmail)\\.(com|net|org)$"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Block bulk financial threats from educational domains"
    criteria:
      type: "And"
      criteria:
        - type: "HeaderPattern"
          header: "to"
          pattern: "(?i)undisclosed.{0,15}recipients"
        - type: "SubjectPattern"
          pattern: "(?i)(unpaid|charges?|amount|\\$[0-9]+\\.[0-9]{2})"
        - type: "SenderPattern"
          pattern: ".*@.*(edu|school|raiders|athletics|university|college)\\..*"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Block email service abuse"
    criteria:
      type: "EmailServiceAbuse"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  # Japanese subject
  - name: "Tag Japanese content"
    criteria:
      type: "SubjectContainsLanguage"
      language: "japanese"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Block DocuSign phishing abuse"
    criteria:
      type: "DocuSignAbuse"
      check_reply_to_mismatch: true      # Check for non-DocuSign reply-to addresses
      check_panic_subjects: true         # Check for urgent/threatening subjects
      check_suspicious_encoding: true    # Check for suspicious base64 encoding
      min_indicators: 2                  # Require at least 2 indicators
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Tag SendGrid abuse with free email sender"
    criteria:
      type: "And"
      criteria:
        # Detect SendGrid infrastructure
        - type: "Or"
          criteria:
            - type: "HeaderPattern"
              header: "return-path"
              pattern: ".*@sendgrid\\.net$"
            - type: "HeaderPattern"
              header: "received"
              pattern: ".*sendgrid\\.net.*"
        # Detect free email sender
        - type: "SenderPattern"
          pattern: ".*@(aol|gmail|outlook|yahoo|hotmail)\\.(com|net)$"
        # Generic business subjects
        - type: "SubjectPattern"
          pattern: "(?i)(order|confirmation|receipt|invoice|payment|delivery)"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Tag Google Groups Temu reward scam"
    criteria:
      type: "GoogleGroupsAbuse"
      suspicious_domains: ["*pool*.com", "*.tk", "*.ml", "*.ga", "*.top"]
      reward_keywords: ["temu", "reward", "survey", "customer experience", "prize"]
      suspicious_sender_names: ["temu", "reward", "your_", "customer"]
      check_domain_reputation: true
      check_reward_subjects: true
      check_suspicious_senders: true
      min_indicators: 2
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Tag sophisticated email spoofing attacks"
    criteria:
      type: "And"
      criteria:
        # MAILER-DAEMON return-path abuse
        - type: "HeaderPattern"
          header: "return-path"
          pattern: "(?i).*mailer-daemon.*"
        # DKIM authentication failures
        - type: "HeaderPattern"
          header: "authentication-results"
          pattern: "(?i)dkim=(fail|permerror|temperror)"
        # Suspicious domains with mixed case patterns
        - type: "SenderPattern"
          pattern: ".*@.*[A-Z]{2,}[a-z]{2,}[A-Z]{2,}.*\\.com$"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Tag suspicious mailto-only unsubscribe (excluding legitimate services)"
    criteria:
      type: "And"
      criteria:
        # Detect mailto-only unsubscribe links
        - type: "UnsubscribeMailtoOnly"
          allow_mixed: true   # Only flag if ALL links are mailto
        # Exclude legitimate business services
        - type: "Not"
          criteria:
            type: "Or"
            criteria:
              # Document signing services
              - type: "SenderPattern"
                pattern: ".*@(signnow|docusign|hellosign|pandadoc|adobe)\\.com$"
              # Email marketing platforms that legitimately use mailto
              - type: "SenderPattern"
                pattern: ".*@(mailchimp|constantcontact|campaignmonitor)\\.com$"
              # Other legitimate services known to use mailto unsubscribe
              - type: "SenderPattern"
                pattern: ".*@(pdffiller)\\.com$"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

  - name: "Block SendGrid tax authority impersonation scams"
    criteria:
      type: "And"
      criteria:
        # SendGrid infrastructure
        - type: "Or"
          criteria:
            - type: "HeaderPattern"
              header: "return-path"
              pattern: ".*@sendgrid\\.net$"
            - type: "HeaderPattern"
              header: "received"
              pattern: ".*sendgrid\\.net.*"
        # Free email sender
        - type: "SenderPattern"
          pattern: ".*@(outlook|gmail|yahoo|hotmail|aol)\\.(com|net)$"
        # Tax/Government impersonation
        - type: "SubjectPattern"
          pattern: "(?i).*(tax|irs|revenue|evasion|audit|refund|penalty|notice|official|authority).*"
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-Flag"
      header_value: "YES"

