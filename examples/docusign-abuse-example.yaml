# DocuSign Infrastructure Abuse Detection Examples
#
# This configuration demonstrates how to detect sophisticated phishing attacks
# that abuse legitimate DocuSign infrastructure for malicious purposes.
#
# The attack pattern typically involves:
# 1. Using legitimate DocuSign infrastructure (eumail.docusign.net)
# 2. Suspicious reply-to addresses (random usernames, suspicious domains)
# 3. Panic/urgent subjects about account suspension or verification
# 4. Base64 encoded From headers with suspicious content
#
# This feature is particularly effective because:
# - Focuses specifically on DocuSign infrastructure abuse
# - Combines multiple indicators for high accuracy
# - Avoids DKIM complexity that could cause false positives
# - Detects sophisticated attacks that bypass traditional filters
#
# Indicators detected:
# - Reply-to domain mismatch (non-DocuSign reply addresses)
# - Panic subjects ("Verify Now: Payment Suspended", etc.)
# - Suspicious base64 encoding in From headers
# - Random usernames and suspicious domain patterns
# - Configurable minimum indicator thresholds

socket_path: "/var/run/foff-milter.sock"
default_action:
  type: "Accept"

rules:
  # Basic DocuSign abuse detection with default settings
  - name: "Block DocuSign phishing abuse"
    criteria:
      type: "DocuSignAbuse"
      check_reply_to_mismatch: true      # Check for non-DocuSign reply-to addresses
      check_panic_subjects: true         # Check for urgent/threatening subjects
      check_suspicious_encoding: true    # Check for suspicious base64 encoding
      min_indicators: 2                  # Require at least 2 indicators
    action:
      type: "Reject"
      message: "DocuSign infrastructure abuse detected"

  # Strict DocuSign abuse detection (single indicator triggers)
  - name: "Strict DocuSign phishing detection"
    criteria:
      type: "DocuSignAbuse"
      check_reply_to_mismatch: true
      check_panic_subjects: true
      check_suspicious_encoding: true
      min_indicators: 1                  # Single indicator is enough
    action:
      type: "TagAsSpam"
      header_name: "X-DocuSign-Abuse"
      header_value: "Potential phishing detected"

  # Conservative DocuSign abuse detection (requires more evidence)
  - name: "Conservative DocuSign abuse detection"
    criteria:
      type: "DocuSignAbuse"
      check_reply_to_mismatch: true
      check_panic_subjects: true
      check_suspicious_encoding: true
      min_indicators: 3                  # Require 3 indicators for high confidence
    action:
      type: "Reject"
      message: "High-confidence DocuSign phishing attack blocked"

  # Focus only on reply-to mismatch (for testing)
  - name: "DocuSign reply-to mismatch only"
    criteria:
      type: "DocuSignAbuse"
      check_reply_to_mismatch: true
      check_panic_subjects: false        # Disable panic subject checking
      check_suspicious_encoding: false   # Disable encoding checking
      min_indicators: 1
    action:
      type: "TagAsSpam"
      header_name: "X-DocuSign-Reply-Mismatch"
      header_value: "Suspicious reply-to address"

  # Focus only on panic subjects (for testing)
  - name: "DocuSign panic subjects only"
    criteria:
      type: "DocuSignAbuse"
      check_reply_to_mismatch: false     # Disable reply-to checking
      check_panic_subjects: true
      check_suspicious_encoding: false   # Disable encoding checking
      min_indicators: 1
    action:
      type: "TagAsSpam"
      header_name: "X-DocuSign-Panic-Subject"
      header_value: "Urgent/threatening subject detected"

  # Focus only on suspicious encoding (for testing)
  - name: "DocuSign suspicious encoding only"
    criteria:
      type: "DocuSignAbuse"
      check_reply_to_mismatch: false     # Disable reply-to checking
      check_panic_subjects: false        # Disable panic subject checking
      check_suspicious_encoding: true
      min_indicators: 1
    action:
      type: "TagAsSpam"
      header_name: "X-DocuSign-Suspicious-Encoding"
      header_value: "Suspicious base64 encoding detected"

# Example of the actual phishing attack this detects:
#
# From: "=?utf-8?B?8J+Fv2F58J+Fv2FsIFJlbWVkaWF0aW9uIFVuaXQgdmlhIERvY3VzaWdu?=" <dse@eumail.docusign.net>
# Reply-To: "deloria548472" <deloria548472@ysl.awesome47.com>
# Subject: Verify Now: Payment Suspended for Verification at Our Security Center
#
# Indicators detected:
# 1. Reply-to mismatch: deloria548472@ysl.awesome47.com (not DocuSign domain)
# 2. Panic subject: "Verify Now: Payment Suspended for Verification"
# 3. Suspicious encoding: Base64 encoded "Remediation Unit via DocuSign"
#
# Result: 3 indicators >= 2 required = BLOCKED
