socket_path: "/var/run/foff-milter.sock"
default_action: "Accept"

rules:
  # Basic IP address detection in unsubscribe links
  - name: "Block unsubscribe links with IP addresses"
    criteria:
      type: "UnsubscribeLinkIPAddress"
      check_ipv4: true
      check_ipv6: true
      allow_private_ips: false  # Block private IPs (default)
    action:
      type: "Reject"
      message: "Unsubscribe link uses IP address instead of domain name"

  # Comprehensive IP address detection (including private IPs)
  - name: "Block all IP-based unsubscribe links"
    criteria:
      type: "UnsubscribeLinkIPAddress"
      check_ipv4: true
      check_ipv6: true
      allow_private_ips: true   # Flag even private IPs
    action:
      type: "Reject"
      message: "Unsubscribe link uses IP address (including private IPs)"

  # IPv4-only detection (for specific threat patterns)
  - name: "Block IPv4 unsubscribe links only"
    criteria:
      type: "UnsubscribeLinkIPAddress"
      check_ipv4: true
      check_ipv6: false
      allow_private_ips: false
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-IPv4-Unsubscribe"
      header_value: "Unsubscribe link uses IPv4 address"

  # IPv6-only detection (for advanced threats)
  - name: "Block IPv6 unsubscribe links only"
    criteria:
      type: "UnsubscribeLinkIPAddress"
      check_ipv4: false
      check_ipv6: true
      allow_private_ips: false
    action:
      type: "TagAsSpam"
      header_name: "X-Spam-IPv6-Unsubscribe"
      header_value: "Unsubscribe link uses IPv6 address"

  # Combined rule: Free email + IP address unsubscribe
  - name: "Block free email with IP-based unsubscribe links"
    criteria:
      type: "And"
      criteria:
        - type: "SenderPattern"
          pattern: ".*@(gmail|outlook|yahoo|hotmail)\\.(com|net)$"
        - type: "UnsubscribeLinkIPAddress"
          check_ipv4: true
          check_ipv6: true
          allow_private_ips: false
    action:
      type: "Reject"
      message: "Free email service with IP-based unsubscribe link"

  # Enhanced phishing detection: Random sender + IP unsubscribe
  - name: "Block random senders with IP unsubscribe links"
    criteria:
      type: "And"
      criteria:
        - type: "SenderPattern"
          pattern: "^[a-z]{10,}\\d*@(gmail|outlook|yahoo)\\.(com|net)$"
        - type: "UnsubscribeLinkIPAddress"
          check_ipv4: true
          check_ipv6: true
          allow_private_ips: true
    action:
      type: "Reject"
      message: "Random sender with IP-based unsubscribe link"

  # Suspicious pattern: IP unsubscribe + commercial subject
  - name: "Block IP unsubscribe with commercial subjects"
    criteria:
      type: "And"
      criteria:
        - type: "UnsubscribeLinkIPAddress"
          check_ipv4: true
          check_ipv6: false
          allow_private_ips: false
        - type: "SubjectPattern"
          pattern: "(?i)(order|invoice|payment|confirmation|receipt|delivery|shipment)"
    action:
      type: "Reject"
      message: "Commercial email with IP-based unsubscribe link"

  # Monitoring mode: Tag all IP-based unsubscribe links
  - name: "Tag IP-based unsubscribe links for analysis"
    criteria:
      type: "UnsubscribeLinkIPAddress"
      check_ipv4: true
      check_ipv6: true
      allow_private_ips: true
    action:
      type: "TagAsSpam"
      header_name: "X-IP-Unsubscribe"
      header_value: "Unsubscribe link contains IP address"

  # High-security mode: Block any IP usage in unsubscribe
  - name: "High security IP blocking"
    criteria:
      type: "Or"
      criteria:
        - type: "UnsubscribeLinkIPAddress"
          check_ipv4: true
          check_ipv6: false
          allow_private_ips: true
        - type: "UnsubscribeLinkIPAddress"
          check_ipv4: false
          check_ipv6: true
          allow_private_ips: true
    action:
      type: "Reject"
      message: "Any IP address usage in unsubscribe links blocked"

  # Specific threat pattern: Public IP + suspicious TLD
  - name: "Block public IP unsubscribe from suspicious domains"
    criteria:
      type: "And"
      criteria:
        - type: "UnsubscribeLinkIPAddress"
          check_ipv4: true
          check_ipv6: true
          allow_private_ips: false  # Only public IPs
        - type: "SenderPattern"
          pattern: ".*@.*\\.(tk|ml|ga|cf|cn|ru)$"
    action:
      type: "Reject"
      message: "Public IP unsubscribe from suspicious TLD domain"
