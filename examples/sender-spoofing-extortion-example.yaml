socket_path: "/var/run/foff-milter.sock"
default_action:
  type: "Accept"

# Statistics configuration (optional)
statistics:
  enabled: true
  database_path: "/var/lib/foff-milter/stats.db"
  flush_interval_seconds: 60

rules:
  # Example 1: Basic sender spoofing extortion detection with defaults
  - name: "Block sender spoofing extortion attempts"
    criteria:
      type: "SenderSpoofingExtortion"
      # All options use defaults:
      # - extortion_keywords: payment, bitcoin, blackmail, compromising, etc.
      # - check_sender_recipient_match: true
      # - check_external_source: true (excludes private IPs)
      # - check_missing_authentication: true
      # - require_extortion_content: true
      # - min_indicators: 2 (requires at least 2 indicators)
    action:
      type: "Reject"
      message: "Sender spoofing extortion attempt blocked"

  # Example 2: Custom extortion detection with specific keywords
  - name: "Custom extortion detection"
    criteria:
      type: "SenderSpoofingExtortion"
      extortion_keywords: ["bitcoin", "cryptocurrency", "payment", "blackmail", "compromising", "expose", "reveal"]
      check_sender_recipient_match: true
      check_external_source: true
      check_missing_authentication: true
      require_extortion_content: true
      min_indicators: 2
    action:
      type: "TagAsSpam"
      header_name: "X-Sender-Spoofing-Extortion"
      header_value: "Extortion attempt detected"

  # Example 3: Focus only on sender spoofing (disable other checks)
  - name: "Self-addressed emails with extortion content"
    criteria:
      type: "SenderSpoofingExtortion"
      check_sender_recipient_match: true
      check_external_source: false
      check_missing_authentication: false
      require_extortion_content: true
      min_indicators: 2  # Sender match + extortion content
    action:
      type: "TagAsSpam"
      header_name: "X-Self-Addressed-Extortion"
      header_value: "Self-addressed extortion email"

  # Example 4: Comprehensive detection with multiple patterns
  - name: "Advanced sender spoofing extortion detection"
    criteria:
      type: "And"
      criteria:
        # Must have sender spoofing extortion indicators
        - type: "SenderSpoofingExtortion"
          check_sender_recipient_match: true
          check_external_source: true
          check_missing_authentication: true
          require_extortion_content: true
          min_indicators: 2
        
        # Additional suspicious patterns
        - type: "Or"
          criteria:
            # Cryptocurrency terms
            - type: "SubjectPattern"
              pattern: "(?i)(bitcoin|btc|cryptocurrency|crypto|wallet|blockchain)"
            
            # Urgency/deadline terms
            - type: "SubjectPattern"
              pattern: "(?i)(24.*hours|48.*hours|deadline|expires|time.*limit|act.*now|immediate.*action)"
            
            # Threat terms
            - type: "SubjectPattern"
              pattern: "(?i)(expose|reveal|publish|share|distribute|family.*friends|social.*media)"
    action:
      type: "Reject"
      message: "Advanced sender spoofing extortion with multiple threat indicators"

  # Example 5: Bitcoin/cryptocurrency extortion specific
  - name: "Bitcoin extortion detection"
    criteria:
      type: "And"
      criteria:
        # Sender spoofing pattern
        - type: "SenderSpoofingExtortion"
          extortion_keywords: ["bitcoin", "btc", "cryptocurrency", "crypto", "wallet", "digital currency"]
          check_sender_recipient_match: true
          check_external_source: true
          check_missing_authentication: true
          require_extortion_content: true
          min_indicators: 2
        
        # Bitcoin-specific patterns
        - type: "Or"
          criteria:
            - type: "SubjectPattern"
              pattern: "(?i)(bitcoin|btc|cryptocurrency|crypto.*wallet)"
            - type: "HeaderPattern"
              header: "subject"
              pattern: "(?i)(payment|pay.*now|send.*money|transfer.*funds)"
    action:
      type: "Reject"
      message: "Bitcoin extortion via sender spoofing blocked"

  # Example 6: Sextortion/blackmail specific
  - name: "Sextortion detection"
    criteria:
      type: "SenderSpoofingExtortion"
      extortion_keywords: ["compromising", "embarrassing", "adult content", "intimate video", "private video", "webcam", "recording", "masturbat", "expose", "reveal"]
      check_sender_recipient_match: true
      check_external_source: true
      check_missing_authentication: true
      require_extortion_content: true
      min_indicators: 2
    action:
      type: "Reject"
      message: "Sextortion attempt via sender spoofing blocked"

  # Example 7: Low threshold detection for monitoring
  - name: "Monitor potential sender spoofing"
    criteria:
      type: "SenderSpoofingExtortion"
      check_sender_recipient_match: true
      check_external_source: true
      check_missing_authentication: true
      require_extortion_content: false  # Don't require extortion content
      min_indicators: 1  # Lower threshold for monitoring
    action:
      type: "TagAsSpam"
      header_name: "X-Potential-Sender-Spoofing"
      header_value: "Monitoring - potential spoofing detected"

  # Example 8: Domain-specific protection
  - name: "Protect specific domain from spoofing"
    criteria:
      type: "And"
      criteria:
        # Sender spoofing targeting specific domain
        - type: "Or"
          criteria:
            - type: "SenderPattern"
              pattern: ".*@yourdomain\\.com$"
            - type: "HeaderPattern"
              header: "from"
              pattern: ".*@yourdomain\\.com"
        
        # Recipient also from same domain (spoofing pattern)
        - type: "RecipientPattern"
          pattern: ".*@yourdomain\\.com$"
        
        # External source or missing auth
        - type: "Or"
          criteria:
            - type: "HeaderPattern"
              header: "received"
              pattern: "from \\[[0-9]+\\.[0-9]+\\.[0-9]+\\.[0-9]+\\]"
            - type: "HeaderPattern"
              header: "authentication-results"
              pattern: "dkim=(none|fail)"
        
        # Extortion content
        - type: "SubjectPattern"
          pattern: "(?i)(payment|bitcoin|blackmail|compromising|expose|reveal)"
    action:
      type: "Reject"
      message: "Domain spoofing extortion attempt blocked"

# Real-world patterns this catches:
#
# 1. Classic sender spoofing: From=To with extortion content from external IP
# 2. Bitcoin extortion: "Waiting for the payment" with cryptocurrency terms
# 3. Sextortion: "I have compromising video" with sender=recipient
# 4. Missing authentication: External emails claiming to be from recipient's domain
# 5. Urgency tactics: "24 hours to pay" with deadline pressure
#
# This feature is particularly effective because:
# - Legitimate emails are never self-sent with extortion content from external sources
# - Combines multiple indicators (spoofing + content + source + auth) for accuracy
# - Excludes private IP ranges to avoid false positives from internal mail servers
# - Whitelists legitimate email services (SparkPost, SendGrid, Mailchimp, etc.)
# - Smart evidence requirements: Requires stronger evidence for forwarded/newsletter emails
# - Configurable thresholds allow fine-tuning for different environments
# - Comprehensive keyword matching catches various extortion/sextortion patterns
#
# Legitimate services automatically whitelisted:
# - Email services: SparkPost, SendGrid, Mailchimp, ConstantContact, Mailgun, etc.
# - Smart detection: Gmail forwarding patterns and newsletter subjects require stronger evidence
#
# Indicators detected:
# - Sender-recipient address matching (spoofing)
# - Extortion keywords in subject/body (payment, bitcoin, blackmail, etc.)
# - External IP sources (excluding private ranges)
# - Missing or failed DKIM authentication
# - Configurable minimum indicator thresholds
# - Dynamic thresholds: Higher requirements for suspicious forwarding patterns
